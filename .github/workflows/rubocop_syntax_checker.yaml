name: Rubocop
on:
  push:
    branches:
      - master
    paths:
      - 'scripts/**'
      - 'type_data/migrations/**'
  pull_request:
    paths:
      - 'scripts/**'
      - 'type_data/migrations/**'

permissions:
  contents: write
  pull-requests: write

jobs:
  rubocop:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        ruby: ['3.3']
    name: Run Rubocop on Ruby ${{ matrix.ruby }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event_name == 'pull_request' && github.head_ref || github.ref }}
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: ${{ matrix.ruby }}
          bundler-cache: true
      
      - name: Run Rubocop autocorrect on changed files
        run: |
          # Get list of changed Ruby files (.rb, .rbw, and .lic)
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            git fetch origin ${{ github.base_ref }}
            CHANGED_FILES=$(git diff --name-only --diff-filter=ACM -z origin/${{ github.base_ref }} HEAD | grep -zE '\.(rb|rbw|lic)$' || true)
          else
            # For push events, compare with the previous commit
            CHANGED_FILES=$(git diff --name-only --diff-filter=ACM -z ${{ github.event.before }} HEAD | grep -zE '\.(rb|rbw|lic)$' || true)
          fi
          
          if [ -n "$CHANGED_FILES" ]; then
            echo "Running rubocop -a on changed files:"
            echo "$CHANGED_FILES" | tr '\0' '\n'
            echo "$CHANGED_FILES" | xargs -0 -I {} bundle exec rubocop -a {}
          else
            echo "No Ruby, .rbw, or .lic files changed"
          fi
      
      - name: Commit changes
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          if git diff --quiet; then
            echo "No changes to commit"
          else
            git add -u
            git commit -m "Auto-fix: Apply rubocop autocorrections [skip ci]"
            git push
          fi
      
      - name: Run Rubocop check on changed files
        run: |
          # Get list of changed Ruby files (.rb, .rbw, and .lic, including any newly committed fixes)
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            git fetch origin ${{ github.base_ref }}
            CHANGED_FILES=$(git diff --name-only --diff-filter=ACM -z origin/${{ github.base_ref }} HEAD | grep -zE '\.(rb|rbw|lic)$' || true)
          else
            # For push events, compare with the previous commit (before the auto-fix commit)
            CHANGED_FILES=$(git diff --name-only --diff-filter=ACM -z ${{ github.event.before }} HEAD | grep -zE '\.(rb|rbw|lic)$' || true)
          fi
          
          if [ -n "$CHANGED_FILES" ]; then
            echo "Running rubocop check on changed files:"
            echo "$CHANGED_FILES" | tr '\0' '\n'
            echo "$CHANGED_FILES" | xargs -0 -I {} bundle exec rubocop {}
          else
            echo "No Ruby, .rbw, or .lic files to check"
          fi
